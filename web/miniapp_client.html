<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chef Port - –ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --bg-card: #1e293b;
            --bg-surface: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-blue: #3b82f6;
            --accent-blue-hover: #2563eb;
            --accent-gold: #fbbf24;
            --danger: #ef4444;
            --success: #22c55e;
            --border-subtle: rgba(255, 255, 255, 0.08);
            --safe-area-bottom: env(safe-area-inset-bottom, 20px);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-color);
            background-image: url('images/app_bg.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-primary);
            overflow-x: hidden;
            padding-bottom: calc(85px + var(--safe-area-bottom));
            min-height: 100vh;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .view {
            animation: fadeIn 0.3s ease-out;
            display: none;
            padding-bottom: 20px;
        }

        .view.active {
            display: block;
        }

        .container {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* HEADER */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            gap: 12px;
            padding: 16px 16px 8px;
            /* Simple gradient bg to look less dull */
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0) 100%);
        }

        .header-back-btn {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-primary);
            flex-shrink: 0;
            transition: transform 0.1s;
        }

        .header-back-btn:active {
            transform: scale(0.95);
        }

        .section-title {
            font-size: 28px;
            font-weight: 800;
            margin: 0;
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* SEARCH */
        .search-bar {
            padding: 0 16px 16px;
        }

        .search-bar input {
            width: 100%;
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            padding: 12px 14px 12px 40px;
            border-radius: 14px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .search-bar input:focus {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            background: var(--bg-card);
        }

        .search-Wrapper {
            position: relative;
        }

        .search-icon-overlay {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            opacity: 0.6;
            pointer-events: none;
        }

        /* –•–ò–¢–´ (SCROLL) - Moved Top */
        .hits-section {
            padding: 0 0 24px;
        }

        .hits-header {
            font-size: 16px;
            font-weight: 700;
            margin: 0 16px 12px;
            color: var(--accent-gold);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .hits-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 0 16px 4px;
            /* side padding inside scroll container */
            scrollbar-width: none;
        }

        .hits-scroll::-webkit-scrollbar {
            display: none;
        }

        .hit-card {
            min-width: 130px;
            max-width: 140px;
            background: var(--bg-card);
            border-radius: 14px;
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            flex-shrink: 0;
            cursor: pointer;
            position: relative;
        }

        .hit-badge {
            position: absolute;
            top: 6px;
            left: 6px;
            background: linear-gradient(135deg, #ff6b35, #ff4444);
            color: white;
            font-size: 9px;
            font-weight: 800;
            padding: 3px 6px;
            border-radius: 6px;
            z-index: 2;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .hit-img {
            height: 90px;
            background: var(--bg-surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            overflow: hidden;
        }

        .hit-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hit-content {
            padding: 8px 10px;
        }

        .hit-name {
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .hit-price {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* –ö–ê–¢–ï–ì–û–†–ò–ò */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 0 16px;
            margin-bottom: 24px;
        }

        .category-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 90px;
            cursor: pointer;
            border: 1px solid var(--border-subtle);
            transition: transform 0.1s, background 0.2s;
            position: relative;
            overflow: hidden;
        }

        .category-card:active {
            transform: scale(0.97);
            background: var(--bg-surface);
        }

        /* Gradient overlay for "plate look" or just style */
        .category-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.03), transparent);
            pointer-events: none;
        }

        .category-icon {
            font-size: 28px;
            margin-bottom: 6px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .category-name {
            font-size: 13px;
            font-weight: 600;
            line-height: 1.2;
            color: var(--text-primary);
        }

        /* –¢–û–í–ê–†–´ (LIST STYLE - "INLINE") */
        .products-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 0 16px 20px;
        }

        .product-item {
            display: flex;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 10px;
            border: 1px solid var(--border-subtle);
            gap: 12px;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .product-item:active {
            background: var(--bg-surface);
        }

        .product-img {
            width: 64px;
            height: 64px;
            border-radius: 12px;
            background: var(--bg-surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
            object-fit: cover;
            overflow: hidden;
        }

        .product-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .product-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-meta {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .product-price {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .product-unit {
            font-size: 11px;
            color: var(--text-muted);
        }

        .add-btn {
            width: 32px;
            height: 32px;
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--accent-blue);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-btn:active {
            background: var(--accent-blue);
            color: white;
        }

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-around;
            padding: 10px 0 calc(10px + var(--safe-area-bottom));
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-muted);
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            padding: 4px 16px;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: var(--accent-blue);
        }

        .nav-item:active {
            opacity: 0.7;
        }

        .nav-icon {
            font-size: 20px;
        }

        /* –ú–û–î–ê–õ–ö–ê */
        .product-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: none;
            align-items: flex-end;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .product-modal.active {
            display: flex;
            animation: fadeIn 0.2ms;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 600px;
            padding: 0;
            /* Remove padding to let image fill top */
            border-top: 1px solid var(--border-subtle);
            padding-bottom: calc(30px + var(--safe-area-bottom));
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            /* Limit height */
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            /* More visible on image */
            border-radius: 100px;
            z-index: 10;
        }

        .modal-img-wrap {
            width: 100%;
            height: 55vh;
            /* Increased to 1.4x as requested */
            min-height: 350px;
            border-radius: 24px 24px 0 0;
            background: var(--bg-surface);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            flex-shrink: 0;
            overflow: hidden;
            position: relative;
        }

        .modal-img-wrap img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-header {
            display: block;
            /* Stack title and price */
            margin-bottom: 20px;
            margin-top: 0;
        }

        .modal-info {
            flex: 1;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .modal-price-tag {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-blue);
            margin-bottom: 16px;
            display: block;
        }

        /* Action Row: Quantity + Add Button */
        .action-row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-top: auto;
            /* Push to bottom */
        }

        .qty-control {
            background: var(--bg-surface);
            border-radius: 16px;
            padding: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border-subtle);
            flex: 1;
            /* Take remaining space */
            max-width: 160px;
            /* But not too wide */
        }

        .qty-action {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--bg-card);
            border: none;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .qty-action:active {
            transform: scale(0.95);
        }

        .qty-display {
            font-size: 18px;
            font-weight: 700;
            width: 40px;
            text-align: center;
        }

        .modal-add {
            flex: 2;
            /* Take twice as much space as qty */
            padding: 16px;
            background: var(--success);
            /* GREEN BUTTON */
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            height: 58px;
            /* Match qty control height approx */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .modal-add:active {
            opacity: 0.9;
            transform: scale(0.99);
        }

        /* –ö–û–†–ó–ò–ù–ê –ò –û–§–û–†–ú–õ–ï–ù–ò–ï */
        .cart-total-float {
            position: fixed;
            bottom: calc(70px + var(--safe-area-bottom));
            left: 16px;
            right: 16px;
            background: var(--accent-blue);
            padding: 14px 20px;
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: 700;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
            z-index: 900;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .cart-total-float:active {
            transform: scale(0.98);
        }

        .cart-list-item {
            background: var(--bg-card);
            padding: 10px 12px;
            border-radius: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--border-subtle);
        }

        .disclaimer-box {
            margin-top: 16px;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.2);
            color: var(--accent-gold);
            padding: 12px;
            border-radius: 12px;
            font-size: 12px;
            line-height: 1.4;
        }

        /* –ò–°–¢–û–†–ò–Ø –ó–ê–ö–ê–ó–û–í - FULL */
        .order-card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            margin-bottom: 12px;
            overflow: hidden;
        }

        .order-header {
            padding: 12px 16px;
            background: var(--bg-surface);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            font-weight: 600;
        }

        .order-body {
            padding: 12px 16px;
        }

        .order-item-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .order-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-new {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }

        .repeat-btn {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .repeat-btn:active {
            background: var(--border-subtle);
        }

        .modal-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: white;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
            transition: transform 0.2s;
        }

        .modal-close-btn:active {
            transform: scale(0.9);
            background: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>

<body>

    <!-- –ö–ê–¢–ê–õ–û–ì -->
    <div class="view active" id="view-catalog">
        <div class="section-header">
            <!-- –ö–Ω–æ–ø–∫–∞ –ù–ê–ó–ê–î -->
            <button class="header-back-btn" id="catalog-back-btn" onclick="selectCategory('all')"
                style="display: none;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
            <!-- RENAMED FROM MENU TO CATEGORIES -->
            <h2 class="section-title" id="products-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤</h2>
            <div style="width: 40px;"></div>
        </div>

        <!-- –•–ò–¢–´ –ü–†–û–î–ê–ñ - MOVED TO TOP -->
        <div class="hits-section" id="hits-section">
            <div class="hits-header">üî• –•–∏—Ç—ã –ø—Ä–æ–¥–∞–∂</div>
            <div class="hits-scroll" id="hits-container">
                <!-- JS Inject -->
            </div>
        </div>

        <div class="search-bar">
            <div class="search-Wrapper">
                <div class="search-icon-overlay">üîç</div>
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ (–ª–æ—Å–æ—Å—å, –∫—Ä–µ–≤–µ—Ç–∫–∏...)"
                    oninput="renderProducts()">
            </div>
        </div>

        <!-- –ö–ê–¢–ï–ì–û–†–ò–ò -->
        <div class="categories-grid" id="categories-grid">
            <!-- JS Inject -->
        </div>

        <!-- –°–ü–ò–°–û–ö –¢–û–í–ê–†–û–í -->
        <div class="products-list" id="products-list">
            <!-- JS Inject -->
        </div>

        <!-- –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã -->
        <div class="cart-total-float" id="cart-float-btn" style="display: none;" onclick="switchView('cart')">
            <span id="float-qty">üõí 0</span>
            <span id="float-sum">0 ‚ÇΩ</span>
        </div>
    </div>

    <!-- –ö–û–†–ó–ò–ù–ê -->
    <div class="view" id="view-cart">
        <div class="section-header">
            <button class="header-back-btn" onclick="switchView('catalog')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
            <h2 class="section-title">–ö–æ—Ä–∑–∏–Ω–∞</h2>
            <div style="width: 40px;"></div>
        </div>

        <div class="products-list" id="cart-items-container">
            <!-- JS Inject -->
        </div>

        <div class="container">
            <!-- DISCLAIMER -->
            <div class="disclaimer-box">
                ‚ÑπÔ∏è <b>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ:</b><br>
                –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è –ø–æ—Å–ª–µ –≤–∑–≤–µ—à–∏–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è
                –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
            </div>
            <br>
            <button class="modal-add" id="checkout-btn" onclick="goToCheckout()" style="display: none;">–û—Ñ–æ—Ä–º–∏—Ç—å
                –∑–∞–∫–∞–∑</button>
        </div>
    </div>

    <!-- –ó–ê–ö–ê–ó–´ -->
    <div class="view" id="view-orders">
        <div class="section-header">
            <h2 class="section-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h2>
        </div>
        <div class="container" id="orders-list">
            <div style="text-align: center; color: var(--text-muted); margin-top: 40px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <!-- –ü–†–û–§–ò–õ–¨ -->
    <div class="view" id="view-profile">
        <div class="section-header">
            <h2 class="section-title">–ü—Ä–æ—Ñ–∏–ª—å</h2>
        </div>
        <div class="container">
            <div class="category-card" style="height: auto; align-items: center; margin-bottom: 20px;">
                <div style="font-size: 40px; margin-bottom: 10px;">üë§</div>
                <div style="font-size: 18px; font-weight: 700;" id="profile-name">–ì–æ—Å—Ç—å</div>
                <div style="color: var(--text-muted); font-size: 13px;" id="profile-id">ID: --</div>
            </div>
        </div>
    </div>

    <!-- –û–§–û–†–ú–õ–ï–ù–ò–ï -->
    <div class="view" id="view-checkout">
        <div class="section-header">
            <button class="header-back-btn" onclick="switchView('cart')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </button>
            <h2 class="section-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h2>
            <div style="width: 40px;"></div>
        </div>
        <div class="container">
            <div style="margin-bottom: 16px;">
                <label style="display: block; color: var(--text-muted); font-size: 12px; margin-bottom: 6px;">–ò–º—è
                    –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
                <input type="text" id="checkout-name"
                    style="width:100%; padding:14px; border-radius:12px; border:1px solid var(--border-subtle); background:var(--bg-surface); color:white; outline:none;">
            </div>

            <div style="margin-bottom: 16px;">
                <label
                    style="display: block; color: var(--text-muted); font-size: 12px; margin-bottom: 6px;">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input type="tel" id="checkout-phone"
                    style="width:100%; padding:14px; border-radius:12px; border:1px solid var(--border-subtle); background:var(--bg-surface); color:white; outline:none;"
                    placeholder="+7">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; color: var(--text-muted); font-size: 12px; margin-bottom: 6px;">–°–ø–æ—Å–æ–±
                    –ø–æ–ª—É—á–µ–Ω–∏—è</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button class="qty-action"
                        style="width:100%; height: auto; padding: 12px; font-size: 13px; font-weight: 600; border-radius: 12px;"
                        id="btn-pickup" onclick="setDelivery('pickup')">–°–∞–º–æ–≤—ã–≤–æ–∑</button>
                    <button class="qty-action"
                        style="width:100%; height: auto; padding: 12px; font-size: 13px; font-weight: 600; border-radius: 12px;"
                        id="btn-delivery" onclick="setDelivery('delivery')">–î–æ—Å—Ç–∞–≤–∫–∞</button>
                </div>
            </div>

            <div id="address-block" style="margin-bottom: 16px; display: none;">
                <label style="display: block; color: var(--text-muted); font-size: 12px; margin-bottom: 6px;">–ê–¥—Ä–µ—Å
                    –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                <input type="text" id="checkout-address"
                    style="width:100%; padding:14px; border-radius:12px; border:1px solid var(--border-subtle); background:var(--bg-surface); color:white; outline:none;"
                    placeholder="–£–ª–∏—Ü–∞, –¥–æ–º, –∫–≤–∞—Ä—Ç–∏—Ä–∞">
            </div>

            <button class="modal-add" style="margin-top: 10px; background: var(--success);"
                onclick="submitOrder()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
            <div style="text-align: center; font-size: 11px; color: var(--text-muted); margin-top: 12px;">–û–ø–ª–∞—Ç–∞ –ø–æ—Å–ª–µ
                —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º</div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê (–í–´–ë–û–† –í–ï–°–ê) -->
    <div class="product-modal" id="product-modal" onclick="if(event.target===this) closeModal()">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-img-wrap" id="modal-img-wrap">üêü</div>
                <div class="modal-info">
                    <div class="modal-title" id="modal-title">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                    <div class="modal-price-tag" id="modal-price">1000 ‚ÇΩ</div>
                </div>
            </div>

            <div class="qty-control">
                <button class="qty-action" onclick="changeQty(-1)">‚àí</button>
                <div class="qty-display" id="modal-qty">1 –∫–≥</div>
                <button class="qty-action" onclick="changeQty(1)">+</button>
            </div>

            <button class="modal-add" onclick="addToCartModal()">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>
    </div>

    <!-- Nav -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchView('catalog')" data-view="catalog">
            <span class="nav-icon">üè†</span><span>–ú–µ–Ω—é</span>
        </div>
        <div class="nav-item" onclick="switchView('cart')" data-view="cart">
            <span class="nav-icon">üõí</span><span>–ö–æ—Ä–∑–∏–Ω–∞</span>
        </div>
        <div class="nav-item" onclick="switchView('orders')" data-view="orders">
            <span class="nav-icon">üìú</span><span>–ó–∞–∫–∞–∑—ã</span>
        </div>
        <div class="nav-item" onclick="switchView('profile')" data-view="profile">
            <span class="nav-icon">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
    </nav>

    <!-- LOGIC -->
    <script src="products_data.js"></script>
    <script>
        // CONFIG
        const API_BASE = window.location.origin + '/api';
        const tg = window.Telegram?.WebApp;
        let USER_ID = 0;

        let allProducts = [];
        let allCategories = [];
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        let currentCategory = 'all';

        // STATIC CONFIG - REQUESTED CATEGORIES
        // Used only for fallback icons if DB doesn't have them
        const CAT_ICONS = {
            '–†—ã–±–∞': 'üêü',
            '–ò–∫—Ä–∞': 'üç£',
            '–ú–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã': 'ü¶ê',
            '–ë–∞–∫–∞–ª–µ—è': 'ü•´',
            '–î–µ–ª–∏–∫–∞—Ç–µ—Å—ã': 'ü•Ø',
            '–ó–∞–º–æ—Ä–æ–∑–∫–∞': '‚ùÑÔ∏è',
            '–ü–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã': 'ü•ü',
            '–†–∞–∑–Ω–æ–µ': 'üçΩ'
        };

        const DEMO_P = [
            { id: 1, name: '–°—Ç–µ–π–∫ –§–æ—Ä–µ–ª–∏', priceperkg: 1890, is_weighted: true, is_hit: true, category: 'fish' },
            { id: 2, name: '–ö—Ä–µ–≤–µ—Ç–∫–∏ 16/20', priceperkg: 1200, is_weighted: false, is_hit: true, category: 'seafood' },
            { id: 3, name: '–ò–∫—Ä–∞ –ö–µ—Ç—ã', priceperkg: 6500, is_weighted: true, is_hit: true, category: 'caviar' },
            { id: 4, name: '–ü–µ–ª—å–º–µ–Ω–∏ —Å —Ä—ã–±–æ–π', priceperkg: 600, is_weighted: false, is_hit: false, category: 'semi' }
        ];

        // INIT
        if (tg) {
            tg.ready(); tg.expand();
            tg.enableClosingConfirmation();
            if (tg.initDataUnsafe?.user) {
                USER_ID = tg.initDataUnsafe.user.id;
                document.getElementById('profile-name').textContent = tg.initDataUnsafe.user.first_name;
                document.getElementById('profile-id').textContent = 'ID: ' + USER_ID;
            }
        }

        async function init() {
            // Load Categories from DB
            await loadCategories();

            // Load Products from DB
            await loadProducts();

            // Render
            renderCategories();
            renderProducts();
            renderHits();
            updateCart();

            // Load Orders (Real)
            if (USER_ID) loadOrders();
        }

        async function loadCategories() {
            try {
                const r = await fetch(API_BASE + '/categories/');
                if (r.ok) {
                    allCategories = await r.json();
                }
            } catch (e) { console.error('Cats error', e); }
        }

        async function loadProducts() {
            try {
                const r = await fetch(API_BASE + '/products/');
                if (r.ok) {
                    allProducts = await r.json();
                }
            } catch (e) {
                console.error('Prods error', e);
                // Fallback to static if needed
                if (typeof IMPORTED_PRODUCTS !== 'undefined') allProducts = IMPORTED_PRODUCTS;
            }
        }

        function processProducts(list) {
            // Rough match ID/Category to codes
            return list.map(p => {
                // Heuristic category mapping if DB returns IDs
                if (p.categoryid === 1) p.category = 'fish';
                else if (p.categoryid === 2) p.category = 'seafood';
                else if (p.categoryid === 3) p.category = 'caviar';
                else if (p.categoryid === 4) p.category = 'grocery';
                else p.category = 'other';

                // Demo images fix
                if (!p.image_url) {
                    const d = DEMO_P.find(dp => dp.name.slice(0, 3) === p.name.slice(0, 3));
                    if (d && d.image_url) p.image_url = d.image_url;
                }
                return p;
            });
        }

        // VIEW & NAV
        function switchView(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-' + view).classList.add('active');
            document.querySelector(`.nav-item[data-view="${view}"]`)?.classList.add('active');

            if (view === 'cart') renderCartList();
            if (view === 'orders') loadOrders();
            window.scrollTo(0, 0);
        }

        function selectCategory(catId) {
            currentCategory = catId; // now calls with ID or 'all'
            const backBtn = document.getElementById('catalog-back-btn');
            const hits = document.getElementById('hits-section');
            const catGrid = document.getElementById('categories-grid');
            const title = document.getElementById('products-title');

            if (catId === 'all') {
                backBtn.style.display = 'none';
                hits.style.display = 'block';
                catGrid.style.display = 'grid';
                title.innerHTML = '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤';
            } else {
                backBtn.style.display = 'flex';
                hits.style.display = 'none';
                catGrid.style.display = 'none';

                const cat = allCategories.find(c => c.id === catId);
                if (cat) title.innerHTML = `${cat.icon || ''} ${cat.name}`;
            }
            renderProducts();
            window.scrollTo(0, 0);
        }

        // RENDERERS
        function renderCategories() {
            const el = document.getElementById('categories-grid');
            el.innerHTML = allCategories.map(c => {
                const icon = c.icon || CAT_ICONS[c.name] || 'üì¶';
                // Use image_url (background) if available, or just icon style
                const bgStyle = c.image_url ? `background-image: url('${c.image_url}'); background-size: cover; background-position: center; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.8);` : '';

                return `
                <div class="category-card" onclick="selectCategory(${c.id})" style="${bgStyle}">
                    ${c.image_url ? '' : `<div class="category-icon">${icon}</div>`}
                    <div class="category-name">${c.name}</div>
                </div>`;
            }).join('');
        }

        function renderProducts() {
            const listEl = document.getElementById('products-list');
            let list = allProducts;

            // Filter
            if (currentCategory !== 'all') {
                // Ensure type match (int)
                list = list.filter(p => p.categoryid == currentCategory);
            }

            const q = document.getElementById('search-input').value.toLowerCase();
            if (q) list = list.filter(p => p.name.toLowerCase().includes(q));

            if (!list.length) {
                listEl.innerHTML = '<div style="text-align:center; padding:40px; color:var(--text-muted)">–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                return;
            }

            listEl.innerHTML = list.map(p => {
                return `
                <div class="product-item" onclick="openModal(${p.id})">
                    <div class="product-img">
                         ${p.image_url ? `<img src="${p.image_url}">` : 'üêü'}
                    </div>
                    <div class="product-info">
                        <div class="product-name">
                            ${p.is_hit && currentCategory === 'all' ? '<span class="hit-badge-inline">–•–ò–¢</span>' : ''}
                            ${p.name}
                        </div>
                        <div class="product-meta">
                            <span class="product-price">${Math.round(p.priceperkg)} ‚ÇΩ</span>
                        </div>
                        <div class="product-unit">–∑–∞ ${p.is_weighted ? '1 –∫–≥' : '1 —à—Ç'}</div>
                    </div>
                    <div class="add-btn">+</div>
                </div>`;
            }).join('');
        }

        function renderHits() {
            const hits = allProducts.filter(p => p.is_hit).slice(0, 6);
            if (!hits.length || currentCategory !== 'all') {
                document.getElementById('hits-section').style.display = 'none'; return;
            }
            document.getElementById('hits-section').style.display = 'block';

            document.getElementById('hits-container').innerHTML = hits.map(p => `
                <div class="hit-card" onclick="openModal(${p.id})">
                    <div class="hit-badge">–•–ò–¢</div>
                    <div class="hit-img">${p.image_url ? `<img src="${p.image_url}">` : 'üêü'}</div>
                    <div class="hit-content">
                        <div class="hit-name">${p.name}</div>
                        <div class="hit-price">${Math.round(p.priceperkg)} ‚ÇΩ</div>
                    </div>
                </div>
            `).join('');
        }

        // CART & MODAL (Same logic as before, ensuring robust handling)
        function updateCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
            const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            const count = cart.length;
            const btn = document.getElementById('cart-float-btn');
            if (count > 0) { btn.style.display = 'flex'; document.getElementById('float-qty').textContent = `üõí ${count}`; document.getElementById('float-sum').textContent = Math.round(total) + ' ‚ÇΩ'; }
            else btn.style.display = 'none';
        }

        let modalP = null; let qty = 1;
        function openModal(id) {
            const modal = document.getElementById('product-modal');
            const modalP = allProducts.find(p => p.id === id);

            // Image fallback
            const imgC = modalP.image_url ? `<img src="${modalP.image_url}">` : 'üêü';

            // Inject NEW HTML structure dynamically
            modal.innerHTML = `
            <div class="modal-content" onclick="event.stopPropagation()">
                <button class="modal-close-btn" onclick="closeModal()">‚úï</button>
                <div class="modal-img-wrap">${imgC}</div>
                
                <div class="modal-body">
                    <div class="modal-header">
                        <div class="modal-title">${modalP.name}</div>
                        <div class="modal-price-tag">${Math.round(modalP.priceperkg)} ‚ÇΩ <span style="font-size:14px; font-weight:400; color:var(--text-muted)">/ ${modalP.is_weighted ? '1 –∫–≥' : '1 —à—Ç'}</span></div>
                        <div style="font-size:14px; color:var(--text-secondary); line-height:1.4">
                            ${modalP.description || '–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.'}
                        </div>
                    </div>

                    <div class="action-row">
                        <div class="qty-control">
                            <button class="qty-action" onclick="changeQty(-1)">‚àí</button>
                            <div class="qty-display" id="modal-qty">1</div>
                            <button class="qty-action" onclick="changeQty(1)">+</button>
                        </div>
                        <button class="modal-add" onclick="addToCartModal()">
                            –í –∫–æ—Ä–∑–∏–Ω—É
                        </button>
                    </div>
                </div>
            </div>`;

            modal.classList.add('active');

            // Set global state for quantity logic
            modalPKey = modalP; // We need to store this if changeQty uses it
            // Actually, existing changeQty uses global 'modalP' variable. 
            // We need to make sure 'modalP' global variable is set.
            window.modalP = modalP;
            window.qty = modalP.is_weighted ? 1.0 : 1;

            // Initial render of qty is already in innerHTML, but let's update strict values
            document.getElementById('modal-qty').textContent = window.qty + (modalP.is_weighted ? ' –∫–≥' : ' —à—Ç');

            if (tg) tg.HapticFeedback.impactOccurred('light');
        }
        function closeModal() { document.getElementById('product-modal').classList.remove('active'); }
        function changeQty(d) {
            if (!window.modalP) return;
            const s = window.modalP.is_weighted ? 0.5 : 1;
            window.qty = Math.max(s, Math.round((window.qty + d * s) * 10) / 10);

            // Direct DOM update instead of updateModalUI
            const qEl = document.getElementById('modal-qty');
            if (qEl) qEl.textContent = window.qty + (window.modalP.is_weighted ? ' –∫–≥' : ' —à—Ç');

            if (tg) tg.HapticFeedback.selectionChanged();
        }
        function updateModalUI() {
            document.getElementById('modal-title').textContent = modalP.name;
            document.getElementById('modal-price').textContent = Math.round(modalP.priceperkg * qty) + ' ‚ÇΩ';
            document.getElementById('modal-qty').textContent = qty + (modalP.is_weighted ? ' –∫–≥' : ' —à—Ç');
            const imgC = modalP.image_url ? `<img src="${modalP.image_url}">` : 'üêü';
            document.getElementById('modal-img-wrap').innerHTML = imgC;
        }
        function addToCartModal() {
            if (!window.modalP) return;
            const ex = cart.find(i => i.id === window.modalP.id);
            if (ex) ex.qty += window.qty; else cart.push({ ...window.modalP, price: window.modalP.priceperkg, qty: window.qty });
            updateCart(); closeModal();
            if (tg) tg.HapticFeedback.notificationOccurred('success');
        }

        function renderCartList() {
            const c = document.getElementById('cart-items-container');
            const total = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            if (!cart.length) { c.innerHTML = '<div style="text-align:center;margin-top:40px;color:var(--text-muted)">–ü—É—Å—Ç–æ</div>'; document.getElementById('checkout-btn').style.display = 'none'; return; }
            document.getElementById('checkout-btn').style.display = 'block';
            document.getElementById('checkout-btn').textContent = `–û—Ñ–æ—Ä–º–∏—Ç—å (~${Math.round(total)} ‚ÇΩ)`;
            c.innerHTML = cart.map(i => `
                 <div class="cart-list-item">
                     <button onclick="rimCart(${i.id})" style="background:none; border:none; color:var(--danger); font-size:20px;">√ó</button>
                     <div style="flex:1">
                         <div style="font-weight:600; font-size:14px;">${i.name}</div>
                         <div style="color:var(--text-muted); font-size:12px;">${i.qty} ${i.is_weighted ? '–∫–≥' : '—à—Ç'} x ${Math.round(i.price)}</div>
                     </div>
                     <div style="font-weight:700; color:var(--accent-blue);">${Math.round(i.price * i.qty)} ‚ÇΩ</div>
                 </div>`).join('');
        }
        function rimCart(id) { cart = cart.filter(i => i.id !== id); updateCart(); renderCartList(); }

        let chType = 'pickup';
        function goToCheckout() {
            switchView('checkout');
            if (localStorage.getItem('un')) document.getElementById('checkout-name').value = localStorage.getItem('un');

            // PHONE FIX: Force +7
            const phInput = document.getElementById('checkout-phone');
            if (localStorage.getItem('ph')) {
                phInput.value = localStorage.getItem('ph');
            } else {
                phInput.value = '+7';
            }

            // Input Mask Listener
            phInput.oninput = function (e) {
                let v = e.target.value.replace(/[^\d+]/g, '');
                if (!v.startsWith('+7')) {
                    v = '+7' + v.replace(/\+/g, '');
                }
                e.target.value = v.substring(0, 12); // +7 + 10 digits
            };

            setDelivery('pickup');
        }
        function setDelivery(t) {
            chType = t;
            const p = document.getElementById('btn-pickup'), d = document.getElementById('btn-delivery'), a = document.getElementById('address-block');
            if (t === 'pickup') { p.style.borderColor = 'var(--accent-blue)'; p.style.color = 'var(--accent-blue)'; d.style.borderColor = 'transparent'; d.style.color = 'white'; a.style.display = 'none'; }
            else { d.style.borderColor = 'var(--accent-blue)'; d.style.color = 'var(--accent-blue)'; p.style.borderColor = 'transparent'; p.style.color = 'white'; a.style.display = 'block'; }
        }
        async function submitOrder() {
            const n = document.getElementById('checkout-name').value, ph = document.getElementById('checkout-phone').value, addr = document.getElementById('checkout-address').value;
            if (!n || !ph) return alert('–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');
            if (chType === 'delivery' && !addr) return alert('–ê–¥—Ä–µ—Å?');
            localStorage.setItem('un', n); localStorage.setItem('ph', ph);

            const body = { user_id: USER_ID, customer_name: n, customer_phone: ph, delivery_method: chType, delivery_address: addr, payment_method: 'card', items: cart.map(i => ({ product_id: i.id, quantity: i.qty })) };
            try {
                const r = await fetch(API_BASE + '/orders/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (r.ok) {
                    const d = await r.json();
                    if (tg) tg.sendData(JSON.stringify({ ...body, order_id: d.id }));
                } else if (tg) tg.sendData(JSON.stringify(body));
            } catch (e) { if (tg) tg.sendData(JSON.stringify(body)); }

            alert('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏.');
            cart = []; updateCart(); switchView('catalog');
        }

        // FULL ORDERS HISTORY
        async function loadOrders() {
            const el = document.getElementById('orders-list');
            el.innerHTML = '<div style="text-align:center; color:var(--text-muted); margin-top:40px">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

            try {
                // Fetch real orders by user
                const r = await fetch(API_BASE + '/orders/?user_id=' + USER_ID);
                if (!r.ok) throw new Error('Failed to load');
                const orders = await r.json();

                if (!orders.length) {
                    el.innerHTML = '<div style="text-align:center; color:var(--text-muted); margin-top:40px">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø—É—Å—Ç–∞</div>';
                    return;
                }

                el.innerHTML = orders.map(o => `
                    <div class="order-card">
                        <div class="order-header">
                            <span>–ó–∞–∫–∞–∑ #${o.id}</span>
                            <span style="color:var(--text-muted)">${new Date(o.created_at).toLocaleDateString()}</span>
                        </div>
                        <div class="order-body">
                            ${(o.items || []).map(i => `
                                <div class="order-item-row">
                                    <span>${i.name} x${i.quantity}</span>
                                    <span>${Math.round(i.price * i.quantity)} ‚ÇΩ</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="order-footer">
                            <span class="order-status status-new">${o.status}</span>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <span style="font-weight:700">${o.total_amount} ‚ÇΩ</span>
                                <button class="repeat-btn" onclick="alert('–ü–æ–≤—Ç–æ—Ä –∑–∞–∫–∞–∑–∞ —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω!')">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (e) {
                el.innerHTML = '<div style="text-align:center; color:var(--text-muted)">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>';
                console.error(e);
            }
        }

        init();
    </script>
</body>

</html>