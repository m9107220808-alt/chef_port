<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chef Port Admin v2</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.7);
            --bg-surface: rgba(51, 65, 85, 0.8);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-blue: #3b82f6;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --border: rgba(255, 255, 255, 0.1);
            --glass: blur(12px);
            --radius: 16px;
        }

        body {
            margin: 0; padding: 0; font-family: 'Inter', sans-serif;
            background: var(--bg-color); color: var(--text-primary);
            padding-bottom: 100px; background-attachment: fixed; background-size: cover;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- UTILS --- */
        .header {
            padding: 12px 16px; background: var(--bg-card);
            backdrop-filter: var(--glass); -webkit-backdrop-filter: var(--glass);
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; z-index: 100;
        }
        .header h1 { margin: 0; font-size: 18px; display: flex; align-items: center; gap: 8px; }

        .nav-tabs { display: flex; gap: 8px; overflow-x: auto; padding-top: 12px; scrollbar-width: none; }
        .nav-tab {
            padding: 6px 14px; background: rgba(255,255,255,0.05);
            border-radius: 20px; font-size: 13px; white-space: nowrap; cursor: pointer;
            transition: 0.3s; color: var(--text-secondary);
        }
        .nav-tab.active { background: var(--accent-blue); color: white; }

        .view-section { display: none; padding: 12px; }
        .view-section.active { display: block; }

        /* --- PRODUCT CARD v2 --- */
        .prod-card {
            background: var(--bg-card); border-radius: var(--radius);
            margin-bottom: 12px; border: 1px solid var(--border);
            overflow: hidden; animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

        /* Card Header (Always Visible) */
        .card-head {
            padding: 10px; display: flex; gap: 10px; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .card-img {
            width: 50px; height: 50px; border-radius: 10px; object-fit: cover; background: #334155;
            flex-shrink: 0; cursor: pointer;
        }
        .card-info { flex: 1; min-width: 0; }
        .card-name { font-weight: 600; font-size: 14px; line-height: 1.2; margin-bottom: 2px; }
        .card-sku { font-size: 11px; color: var(--text-secondary); opacity: 0.7; }
        .card-price { font-size: 15px; font-weight: 700; color: var(--success); }

        /* Card Tabs */
        .card-tabs {
            display: grid; grid-template-columns: 1fr 1fr;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }
        .c-tab {
            text-align: center; padding: 8px; font-size: 12px;
            color: var(--text-secondary); cursor: pointer;
            border-bottom: 2px solid transparent; transition: 0.2s;
        }
        .c-tab.active { color: white; border-bottom-color: var(--accent-blue); background: rgba(255,255,255,0.02); }

        /* Card Body */
        .card-body { padding: 12px; }
        .mode-section { display: none; }
        .mode-section.active { display: block; }

        /* --- MODE 1: PRICING --- */
        .pricing-grid { display: grid; gap: 12px; }
        
        .p-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .p-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Cost Input */
        .cost-input {
            width: 80px; background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            border-radius: 8px; color: white; padding: 6px; text-align: right; font-weight: 500;
        }
        .cost-input.zero { border-color: var(--danger); color: var(--danger); }
        .cost-input:focus { border-color: var(--accent-blue); outline: none; }

        /* Horizontal Scroll Snap Picker */
        .scroll-picker {
            display: flex; gap: 4px; overflow-x: auto; scroll-snap-type: x mandatory;
            padding: 4px 0; -webkit-overflow-scrolling: touch; scrollbar-width: none;
            width: 100%; mask-image: linear-gradient(90deg, transparent, #000 10%, #000 90%, transparent);
            -webkit-mask-image: linear-gradient(90deg, transparent, #000 10%, #000 90%, transparent);
        }
        .pick-item {
            scroll-snap-align: center; flex: 0 0 18%; text-align: center;
            padding: 6px 0; font-size: 12px; border-radius: 8px;
            background: rgba(255,255,255,0.05); color: var(--text-secondary);
            cursor: pointer; transition: 0.2s; border: 1px solid transparent;
        }
        .pick-item.active {
            background: var(--accent-blue); color: white; font-weight: 600; border-color: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        /* Dual Margin Display */
        .dual-margin {
            display: flex; align-items: center; gap: 8px; font-size: 12px;
            background: rgba(0,0,0,0.4); padding: 4px 10px; border-radius: 20px;
        }
        .dm-val { font-weight: 600; }
        .dm-green { color: var(--success); }
        .dm-yellow { color: var(--warning); }
        .dm-red { color: var(--danger); }

        .save-btn {
            width: 100%; background: var(--accent-blue); border: none; padding: 8px;
            border-radius: 8px; color: white; font-weight: 600; margin-top: 8px;
            display: none; cursor: pointer;
        }

        /* --- MODE 2: SUPPLY --- */
        .supply-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .stock-badge { background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 6px; font-size: 12px; }
        
        .qty-ctrl { display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 2px; }
        .q-btn {
            width: 32px; height: 32px; border-radius: 6px; border: none;
            background: rgba(255,255,255,0.1); color: white; font-size: 18px; cursor: pointer;
        }
        .q-input {
            width: 40px; text-align: center; background: none; border: none; color: white; font-weight: 600;
        }
        
        .add-cart-btn {
            width: 100%; background: rgba(34, 197, 94, 0.2); border: 1px solid var(--success);
            color: var(--success); padding: 10px; border-radius: 10px; font-weight: 600; cursor: pointer;
            transition: 0.2s;
        }
        .add-cart-btn:active { background: var(--success); color: white; }

        /* --- SUPPLY DOCK --- */
        .supply-dock {
            position: fixed; bottom: 20px; left: 16px; right: 16px;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(16px);
            padding: 12px 16px; border-radius: 16px; border: 1px solid var(--accent-blue);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
            z-index: 200; transform: translateY(150%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .supply-dock.visible { transform: translateY(0); }
        .dock-info { font-size: 13px; color: white; }
        .dock-btn {
            background: var(--accent-blue); color: white; border: none;
            padding: 8px 16px; border-radius: 10px; font-weight: 600; cursor: pointer;
        }

        .loader { text-align: center; padding: 40px; color: var(--text-secondary); }
    </style>
</head>
<body>

<div class="header">
    <h1>üîß Chef Port <span style="font-size:12px; opacity:0.5; font-weight:400">v2.0</span></h1>
    <div class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('products')">–¢–æ–≤–∞—Ä—ã</div>
        <div class="nav-tab" onclick="switchTab('orders')">–ó–∞–∫–∞–∑—ã</div>
        <div class="nav-tab" onclick="switchTab('categories')">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
    </div>
</div>

<div id="view-products" class="view-section active">
    <!-- Supply Dock -->
    <div class="supply-dock" id="supply-dock">
        <div class="dock-info" id="dock-text">–ü–æ–∑–∏—Ü–∏–π: 0 | 0 ‚ÇΩ</div>
        <button class="dock-btn" onclick="checkoutSupply()">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <div class="prod-list" id="products-list">
        <div class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
    </div>
    <!-- FAB for adding new product -->
    <div style="height: 60px;"></div>
    <button onclick="window.location.reload()" style="position:fixed; bottom:20px; right:20px; width:50px; height:50px; border-radius:50%; background:var(--bg-card); color:#fff; border:1px solid var(--border); z-index:90;">üîÑ</button>
</div>

<div id="view-orders" class="view-section">
    <div class="loader">–†–∞–∑–¥–µ–ª –∑–∞–∫–∞–∑–æ–≤ (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)</div>
</div>

<div id="view-categories" class="view-section">
    <div class="loader">–†–∞–∑–¥–µ–ª –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>
</div>

<script>
    const API_BASE = '/api';
    let products = [];
    let supplyCart = {}; // {id: quantity}

    // --- TELEGRAM INIT ---
    if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.expand(); 
        tg.enableClosingConfirmation();
        tg.setHeaderColor('#0f172a'); 
    }

    // --- MAIN LOGIC ---
    function switchTab(tab) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + tab).classList.add('active');
        document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');
        if (tab === 'products' && products.length === 0) loadProducts();
        if (tab === 'categories') loadCategories();
    }

    async function loadProducts() {
        try {
            const res = await fetch(API_BASE + '/products');
            products = await res.json();
            renderProducts(products);
        } catch (e) { document.getElementById('products-list').innerHTML = `<div class="loader">–û—à–∏–±–∫–∞: ${e}</div>`; }
    }
    
    async function loadCategories() { 
         const res = await fetch(API_BASE + '/categories');
         const cats = await res.json();
         document.getElementById('view-categories').innerHTML = cats.map(c => 
            `<div style="padding:10px; border-bottom:1px solid #333">${c.name}</div>`
         ).join('');
    }

    // --- V2 RENDERER ---
    function renderProducts(list) {
        // Sort by id desc for now
        list.sort((a,b) => b.id - a.id);
        
        const markupRanges = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 60, 70, 80, 90, 100, 120, 150, 200, 300];
        const discountRanges = [0, 5, 10, 15, 20, 25, 30, 40, 50, 70, 90];

        document.getElementById('products-list').innerHTML = list.map(p => {
            const cost = p.cost_price || 0;
            const markup = p.markup || 0;
            const discount = p.discount_percent || 0;
            const price = calculatePrice(cost, markup, discount);
            const marginObj = calculateMargin(price, cost);
            
            return `
            <div class="prod-card" id="card-${p.id}">
                <!-- HEAD -->
                <div class="card-head">
                    <img class="card-img" src="${p.image_url || ''}" onerror="this.style.display='none'">
                    <div class="card-info">
                        <div class="card-name">${p.name}</div>
                        <div class="card-sku">${p.code || 'NO SKU'}</div>
                    </div>
                    <div class="card-price" id="head-price-${p.id}">${Math.round(price)} ‚ÇΩ</div>
                </div>
                
                <!-- TABS -->
                <div class="card-tabs">
                    <div class="c-tab active" onclick="setMode(${p.id}, 'price')" id="tab-price-${p.id}">üí∞ –¶–µ–Ω—ã</div>
                    <div class="c-tab" onclick="setMode(${p.id}, 'supply')" id="tab-supply-${p.id}">üì¶ –ó–∞–∫—É–ø–∫–∞</div>
                </div>

                <!-- BODY -->
                <div class="card-body">
                    
                    <!-- MODE: PRICING -->
                    <div class="mode-section active" id="mode-price-${p.id}">
                        <div class="pricing-grid">
                            
                            <!-- Row 1: Cost & Margin -->
                            <div class="p-row">
                                <div style="flex:1">
                                    <div class="p-label">–ó–∞–∫—É–ø (‚ÇΩ)</div>
                                    <input type="number" class="cost-input ${cost===0?'zero':''}" 
                                           value="${cost}" id="in-cost-${p.id}" oninput="recalc(${p.id})">
                                </div>
                                <div style="flex:2; display:flex; flex-direction:column; align-items:flex-end;">
                                    <div class="p-label" style="text-align:right">–ú–∞—Ä–∂–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å</div>
                                    <div class="dual-margin" id="margin-box-${p.id}">
                                        ${renderMarginHTML(marginObj)}
                                    </div>
                                </div>
                            </div>

                            <!-- Row 2: Markup Picker -->
                            <div>
                                <div class="p-label">–ù–∞—Ü–µ–Ω–∫–∞ (%)</div>
                                <div class="scroll-picker" id="picker-markup-${p.id}">
                                    ${markupRanges.map(v => 
                                        `<div class="pick-item ${v===markup?'active':''}" onclick="setPick(${p.id}, 'markup', ${v})">${v}%</div>`
                                    ).join('')}
                                </div>
                                <input type="hidden" id="val-markup-${p.id}" value="${markup}">
                            </div>

                            <!-- Row 3: Discount Picker -->
                            <div>
                                <div class="p-label">–°–∫–∏–¥–∫–∞ (%)</div>
                                <div class="scroll-picker" id="picker-discount-${p.id}">
                                    ${discountRanges.map(v => 
                                        `<div class="pick-item ${v===discount?'active':''}" onclick="setPick(${p.id}, 'discount', ${v})">${v}%</div>`
                                    ).join('')}
                                </div>
                                <input type="hidden" id="val-discount-${p.id}" value="${discount}">
                            </div>

                            <button class="save-btn" id="btn-save-${p.id}" onclick="saveProduct(${p.id})">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—É—é —Ü–µ–Ω—É</button>

                        </div>
                    </div>

                    <!-- MODE: SUPPLY -->
                    <div class="mode-section" id="mode-supply-${p.id}">
                        <div class="supply-row">
                            <span class="p-label">–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫</span>
                            <span class="stock-badge">${p.in_stock ? '–í –Ω–∞–ª–∏—á–∏–∏' : '–ù–µ—Ç'}</span>
                        </div>
                        <div class="supply-row" style="background: rgba(0,0,0,0.2); padsding: 10px; border-radius:10px;">
                            <div style="font-size:14px; font-weight:600">–í –∑–∞–∫–∞–∑:</div>
                            <div class="qty-ctrl">
                                <button class="q-btn" onclick="adjSupply(${p.id}, -1)">-</button>
                                <input class="q-input" id="supply-qty-${p.id}" value="0" readonly>
                                <button class="q-btn" onclick="adjSupply(${p.id}, 1)">+</button>
                            </div>
                        </div>
                        <button class="add-cart-btn" onclick="addToSupply(${p.id})">–î–æ–±–∞–≤–∏—Ç—å –≤ –ª–∏—Å—Ç –∑–∞–∫—É–ø–∞</button>
                    </div>

                </div>
            </div>
            `;
        }).join('');
    }

    // --- TABS LOGIC ---
    window.setMode = (id, mode) => {
        document.getElementById(`mode-price-${id}`).classList.toggle('active', mode==='price');
        document.getElementById(`mode-supply-${id}`).classList.toggle('active', mode==='supply');
        
        document.getElementById(`tab-price-${id}`).classList.toggle('active', mode==='price');
        document.getElementById(`tab-supply-${id}`).classList.toggle('active', mode==='supply');
    };

    // --- PRICING LOGIC ---
    window.setPick = (id, type, val) => {
        // Update hidden input
        document.getElementById(`val-${type}-${id}`).value = val;
        
        // Update visual active state
        const container = document.getElementById(`picker-${type}-${id}`);
        Array.from(container.children).forEach(el => {
            el.classList.toggle('active', el.textContent === val + '%');
        });

        recalc(id);
    };

    window.recalc = (id) => {
        const costInput = document.getElementById(`in-cost-${id}`);
        let cost = parseFloat(costInput.value) || 0;
        
        // Visual zero check
        if(cost === 0) costInput.classList.add('zero'); else costInput.classList.remove('zero');

        const markup = parseInt(document.getElementById(`val-markup-${id}`).value) || 0;
        const discount = parseInt(document.getElementById(`val-discount-${id}`).value) || 0;

        const price = calculatePrice(cost, markup, discount);
        const marginObj = calculateMargin(price, cost);

        // Update Header Price
        document.getElementById(`head-price-${id}`).textContent = Math.round(price) + ' ‚ÇΩ';
        
        // Update Margin Box
        document.getElementById(`margin-box-${id}`).innerHTML = renderMarginHTML(marginObj);

        // Show Save Button
        document.getElementById(`btn-save-${id}`).style.display = 'block';
    };

    function calculatePrice(cost, markup, discount) {
        let base = cost * (1 + markup / 100);
        let final = base * (1 - discount / 100);
        return final;
    }

    function calculateMargin(finalPrice, cost) {
        let money = finalPrice - cost;
        let percent = finalPrice > 0 ? (money / finalPrice * 100) : 0;
        return { money, percent };
    }

    function renderMarginHTML(m) {
        // Color logic
        let colorClass = 'dm-red';
        if (m.percent > 30) colorClass = 'dm-green';
        else if (m.percent >= 15) colorClass = 'dm-yellow';

        return `
            <span class="${colorClass}">${Math.round(m.percent)}%</span>
            <span style="opacity:0.3">|</span>
            <span class="${colorClass}"><b>${m.money > 0 ? '+' : ''}${Math.round(m.money)} ‚ÇΩ</b></span>
        `;
    }

    window.saveProduct = async (id) => {
        const cost = parseFloat(document.getElementById(`in-cost-${id}`).value) || 0;
        const markup = parseInt(document.getElementById(`val-markup-${id}`).value) || 0;
        const discount = parseInt(document.getElementById(`val-discount-${id}`).value) || 0;
        const finalPrice = calculatePrice(cost, markup, discount);

        const btn = document.getElementById(`btn-save-${id}`);
        btn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

        try {
            const payload = {
                cost_price: cost,
                markup: markup,
                discount_percent: discount,
                is_discount: discount > 0,
                priceperkg: finalPrice
            };
            
            const res = await fetch(API_BASE + '/products/' + id, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if(res.ok) {
                btn.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                setTimeout(() => btn.style.display = 'none', 1500);
            } else {
                btn.textContent = '‚ùå –û—à–∏–±–∫–∞';
            }
        } catch(e) {
            btn.textContent = '‚ùå –°–µ—Ç—å';
        }
    }

    // --- SUPPLY LOGIC ---
    window.adjSupply = (id, delta) => {
        const inp = document.getElementById(`supply-qty-${id}`);
        let val = parseInt(inp.value) || 0;
        val += delta;
        if(val < 0) val = 0;
        inp.value = val;
    }

    window.addToSupply = (id) => {
        const qty = parseInt(document.getElementById(`supply-qty-${id}`).value) || 0;
        if(qty > 0) {
            supplyCart[id] = qty;
            updateDock();
            navigator.vibrate(50); // Haptic
            // Visual feedback
            const btn = event.target;
            const oldText = btn.textContent;
            btn.textContent = '–î–æ–±–∞–≤–ª–µ–Ω–æ!';
            btn.style.background = 'var(--success)';
            btn.style.color = '#fff';
            setTimeout(() => {
                btn.textContent = oldText;
                btn.style.background = '';
                btn.style.color = '';
            }, 1000);
        }
    }

    function updateDock() {
        const count = Object.keys(supplyCart).length;
        let totalCost = 0;
        
        for(let pid in supplyCart) {
            const p = products.find(x => x.id == pid);
            if(p) totalCost += (p.cost_price || 0) * supplyCart[pid];
        }

        const dock = document.getElementById('supply-dock');
        const dockText = document.getElementById('dock-text');
        
        if(count > 0) {
            dock.classList.add('visible');
            dockText.innerHTML = `–ü–æ–∑–∏—Ü–∏–π: <b>${count}</b> <span style="opacity:0.5">|</span> –ó–∞–∫—É–ø: <b>${totalCost.toLocaleString()} ‚ÇΩ</b>`;
        } else {
            dock.classList.remove('visible');
        }
    }

    window.checkoutSupply = () => {
        let text = "üì¶ –ó–ê–ö–ê–ó –ü–û–°–¢–ê–í–©–ò–ö–£:\n\n";
        for(let pid in supplyCart) {
            const p = products.find(x => x.id == pid);
            if(p) text += `- ${p.name}: ${supplyCart[pid]} —à—Ç.\n`;
        }
        
        // Copy to clipboard or alert
        if(window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.showPopup({
                title: '–°–ø–∏—Å–æ–∫ –∑–∞–∫—É–ø–∫–∏',
                message: text,
                buttons: [{type: 'ok'}]
            });
        } else {
            alert(text);
        }
    }

    loadProducts();
</script>
</body>
</html>
